"use client";
import { useEffect } from "react";
import { getProvider } from "@binance/w3w-ethereum-provider";
import { utf8ToHex } from "@binance/w3w-utils";
import Head from "next/head";

import { useState } from "react";

let provider = getProvider({ chainId: 56 });

const disconnect = async () => {
  await provider.disconnect();
};

export default function Home() {
  const [account, setAccount] = useState("");
  const [chainId, setChainId] = useState("0");

  const enable = async (chainId = 56) => {
    provider = getProvider({ chainId });
    provider?.setLng("zh-CN");
    const accounts = await provider.enable();
    console.log("ğŸš€ ~ enable accounts:", accounts);
    setAccount(accounts[0]);
  };
  const getAccount = async () => {
    const accounts = await provider.request({
      method: "eth_accounts",
    });
    console.log(
      "ğŸš€ ~~ file: ethereum-provider.tsx:32 ~~ getAccount ~~ provider.accounts:",
      accounts
    );
    setAccount(accounts[0]);
  };
  const signMessage = async () => {
    const message = "hello world";
    try {
      const res = await provider.request({
        method: "personal_sign",
        params: [utf8ToHex(message), account],
      });
      console.log("ğŸš€ ~ signMessage ~ res:", res);
    } catch (error) {
      throw error;
    }
  };

  const getChainId = async () => {
    const chainId = provider.chainId;
    setChainId(chainId);
  };
  const changeChainId = () => {
    provider?.request({
      method: "wallet_switchEthereumChain",
      params: [{ chainId: "0x26fc" }],
    });
  };
  useEffect(() => {
    if (!provider) return;

    provider.on("accountsChanged", (acc) => {
      setAccount(acc[0]);
    });
    provider.on("chainChanged", (chainId) => {
      setChainId(chainId);
    });
    provider.on("disconnect", () => {
      setChainId("0x0");
      setAccount("");
    });
  }, [provider]);

  const sendTransaction = async () => {
    const payload = {
      from: account,
      to: account,
      value: "0x1",
    };
    const res = await provider.request({
      method: "eth_sendTransaction",
      params: [payload],
    });
    console.log("ğŸš€ ~~ file: client.tsx:62 ~~ sendTransaction ~~ res:", res);
    alert("success");
  };
  const opSendTransaction = async () => {
    const res = await provider.request({
      method: 'eth_sendTransaction',
      params: [
        {
          data: '0x14d9e096000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000038d7ea4c68000000000000000000000000000aadf86a2cc193be699980e7c063ca90bbb487f35',
          from: account,
          gas: '0x19023',
          to: '0x39454a5ad76c379ec1a5281cd93e301fed3995a4', //å‡ºé”™çš„opbnbåˆçº¦åœ°å€
          // to: bridgeAddr[+chainId],
          value: '0xffcffbee1f800',
        },
      ],
    })
    console.log("ğŸš€ ~~ opSendTransaction ~~ res:", res)
  }

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main
        style={{
          height: "100vh",
        }}
      >
        <section>
          <h2>ethereum-provider</h2>
          <button onClick={() => enable()}>enable</button>
          <button onClick={() => enable(787)}>enable Acala EVM</button>
          <button onClick={disconnect}>disconnect</button>
          <button onClick={getAccount}>getAccount</button>
          <button onClick={signMessage}>signMessage</button>
          <button onClick={getChainId}>getChainId</button>
          <button onClick={changeChainId}>changeChainId</button>
          <button onClick={opSendTransaction}>opSendTransaction</button>
          <button onClick={sendTransaction}>sendTransaction</button>
        </section>
        <div>account: {account}</div>
        <div>chainId: {chainId}</div>
      </main>
    </>
  );
}
